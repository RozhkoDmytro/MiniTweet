{% extends 'base.html' %}

{% block title %}MiniTweet - Home{% endblock %}

{% block content %}
    <!-- Messages display -->
    {% if messages %}
        <div class="messages">
            {% for message in messages %}
                <div class="message {{ message.tags }}">
                    {{ message }}
                </div>
            {% endfor %}
        </div>
    {% endif %}
    
    <!-- Tweet creation form -->
    <div class="tweet-form">
        <h3>Create New Tweet</h3>
        <form method="post" enctype="multipart/form-data" action="" id="tweetForm">
            {% csrf_token %}
            <div class="form-group">
                <label for="{{ form.text.id_for_label }}">Tweet Text:</label>
                {{ form.text }}
            </div>
            <div class="form-group">
                <label for="{{ form.image.id_for_label }}">Image (optional):</label>
                {{ form.image }}
                <div id="fileSizeError" style="color: var(--accent-danger); font-size: 12px; margin-top: 5px; display: none;">
                    File too large! Maximum size is 5MB.
                </div>
            </div>
            <button type="submit" class="btn btn-primary" id="submitBtn">Post Tweet</button>
        </form>
        
        <!-- Debug info -->
        <div style="margin-top: 10px; font-size: 12px; color: var(--text-muted);">
            <p>Debug: Form fields available: {{ form.fields.keys|join:", " }}</p>
            <p>Debug: Current user: {{ user.username|default:"Not authenticated" }}</p>
        </div>
    </div>

    <!-- Tweets list -->
    <h3 class="section-title">Recent Tweets</h3>
    <div id="tweetsContainer">
        {% for tweet in tweets %}
            <div class="tweet">
                <div class="tweet-header">
                    <strong>@{{ tweet.user.username }}</strong>
                    <small>{{ tweet.created_at|date:"M d, Y H:i" }}</small>
                </div>
                <div class="tweet-content">
                    {{ tweet.text }}
                </div>
                {% if tweet.image %}
                    <img src="{{ tweet.image.url }}" alt="Tweet image" class="tweet-image">
                {% endif %}
                <div class="tweet-actions">
                    <a href="{% url 'tweets:tweet_detail' tweet.pk %}" class="btn btn-secondary">View & Reply</a>
                    <!-- Edit/Delete buttons temporarily disabled for non-authenticated users -->
                </div>
            </div>
        {% empty %}
            <div class="empty-state">
                <p>No tweets yet. Be the first to post! üê¶</p>
            </div>
        {% endfor %}
    </div>
{% endblock %}

{% block extra_js %}
<script>
    // File size validation
    document.getElementById('{{ form.image.id_for_label }}').addEventListener('change', function(e) {
        const file = e.target.files[0];
        const maxSize = 5 * 1024 * 1024; // 5MB
        const errorDiv = document.getElementById('fileSizeError');
        const submitBtn = document.getElementById('submitBtn');
        
        if (file && file.size > maxSize) {
            errorDiv.style.display = 'block';
            submitBtn.disabled = true;
            submitBtn.style.opacity = '0.5';
            submitBtn.style.cursor = 'not-allowed';
            
            // Clear the file input
            e.target.value = '';
            
            // Show user-friendly message
            alert('File too large! Maximum file size is 5MB. Tweet cannot be published.');
        } else {
            errorDiv.style.display = 'none';
            submitBtn.disabled = false;
            submitBtn.style.opacity = '1';
            submitBtn.style.cursor = 'pointer';
        }
    });
    
    // AJAX form submission to prevent page reload and theme flickering
    document.getElementById('tweetForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const form = this;
        const formData = new FormData(form);
        const submitBtn = document.getElementById('submitBtn');
        const originalText = submitBtn.textContent;
        
        // Disable submit button and show loading state
        submitBtn.disabled = true;
        submitBtn.textContent = 'Posting...';
        submitBtn.style.opacity = '0.7';
        
        // Get CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        fetch('', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': csrfToken,
            }
        })
        .then(response => response.text())
        .then(html => {
            // Create a temporary div to parse the response
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;
            
            // Check for messages
            const messages = tempDiv.querySelector('.messages');
            if (messages) {
                // Show messages
                const messagesContainer = document.querySelector('.messages');
                if (messagesContainer) {
                    messagesContainer.innerHTML = messages.innerHTML;
                } else {
                    // Create messages container if it doesn't exist
                    const newMessagesContainer = document.createElement('div');
                    newMessagesContainer.className = 'messages';
                    newMessagesContainer.innerHTML = messages.innerHTML;
                    document.querySelector('.tweet-form').insertAdjacentElement('beforebegin', newMessagesContainer);
                }
                
                // Auto-hide messages after 5 seconds
                setTimeout(() => {
                    const messagesContainer = document.querySelector('.messages');
                    if (messagesContainer) {
                        messagesContainer.style.opacity = '0';
                        setTimeout(() => messagesContainer.remove(), 300);
                    }
                }, 5000);
            }
            
            // Check for success (redirect would mean success)
            if (html.includes('Tweet posted successfully!')) {
                // Clear form
                form.reset();
                
                // Reload tweets list without full page reload
                location.reload();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            // Show error message
            const errorMessage = document.createElement('div');
            errorMessage.className = 'message error';
            errorMessage.textContent = 'An error occurred while posting the tweet. Please try again.';
            
            const messagesContainer = document.querySelector('.messages');
            if (messagesContainer) {
                messagesContainer.appendChild(errorMessage);
            } else {
                const newMessagesContainer = document.createElement('div');
                newMessagesContainer.className = 'messages';
                newMessagesContainer.appendChild(errorMessage);
                document.querySelector('.tweet-form').insertAdjacentElement('beforebegin', newMessagesContainer);
            }
        })
        .finally(() => {
            // Re-enable submit button
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
            submitBtn.style.opacity = '1';
        });
    });
</script>
{% endblock %}
